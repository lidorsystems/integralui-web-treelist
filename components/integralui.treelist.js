/*
  filename: integralui.treelist.js
  version : 20.2.0
  Copyright Â© 2020 Lidor Systems. All rights reserved.

  This file is part of the "IntegralUI Web Lite" Library. 
                                                                   
  The contents of this file are subject to the IntegralUI Web Lite License, and may not be used except in compliance with the License.
  A copy of the License should have been installed in the product's root installation directory or it can be found at
  http://www.lidorsystems.com/products/web/lite/license-agreement.aspx.
                                                            
  This SOFTWARE is provided "AS IS", WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License for the specific language 
  governing rights and limitations under the License. Any infringement will be prosecuted under applicable laws.                           
*/
import{c as css,h as html}from"../external/lit-element.js";import{c as classMap}from"../external/class-map.js";import{s as styleMap}from"../external/style-map.js";import{IntegralUISpeedMode,IntegralUIObjectState,IntegralUITheme}from"./integralui.enums.js";import IntegralUIBase from"./integralui.base.js";import IntegralUIDataService from"../services/integralui.data.service.js";import"./integralui.scrollbar.js";import"./integralui.treelistitem.js";import{iuiTreeListDefaultStyle}from"../styles/integralui.treelist.style.js";import{iuiTreeListOfficeStyle}from"../themes/office/integralui.treelist.office.js";import{iuiTreeListMidnightStyle}from"../themes/midnight/integralui.treelist.midnight.js";class IntegralUITreeList extends IntegralUIBase{_ini(){super._ini();this._cDtaService=new IntegralUIDataService();this._anItSz={width:0,height:0};this._anSpd=300;this._prvClkOj=null;this._cDtFds={};this._cIts=[];this._cLt=[];this._cTtl="";this._nxtLt=[];this._prvLt=[];this._clkPs={x:0,y:0};this._hdTxt="";this._hIt=null;this._isClk=!1;this._avgItHt=0;this._blkPs={top:30,left:0};this._cInd=15;this._lfBlkPs={top:30,left:-300};this._rtBlkPs={top:30,left:300};this._blkSz={width:9999,height:0};this._cBlkHt=0;this._mxBlkHt=0;this._lfBlkOp=0;this._blkOp=1;this._rtBlkOp=0;this._elSz={width:0,height:0};this._uTmr=null;this._cMuWhSp=IntegralUISpeedMode.Normal;this._cSclPs={x:0,y:0};this._mxSclPs={x:0,y:0};this._scAct=!1;this._scAlw=!0;this._scTmAct=!1;this._prvSclPs={x:0,y:0};this._scAppTm=null;this._scBrSz={width:0,height:0};this._scCt=0;this._scLgChg={x:0,y:0};this._scSz={width:0,height:0};this._scrollTimerID=null;this._cSel=null;this._hdIt=null;this._selLt=[];this._cCtrStyStt=iuiTreeListDefaultStyle;this._gnrCsNm="iui-treelist";this._cDtaService.init([{data:this.items}]);this._uDtFields();this._iniStyle()}connectedCallback(){}disconnectedCallback(){this._rstLyTm();this._rstSclATm()}ngAfterViewInit(){this._blkPs.top=this._headerElem.offsetHeight;this._lfBlkPs.top=this._headerElem.offsetHeight;this._rtBlkPs.top=this._headerElem.offsetHeight;this._anItSz={width:this._headerElem.offsetWidth,height:this._headerElem.offsetHeight};this._elSz={width:this._eRf.firstElementChild.clientWidth,height:this._eRf.firstElementChild.clientHeight};this._leftBlockWidth=this._blockWidth=this._rightBlockWidth=this._elSz.width}attributeChangedCallback(t,e,i){super.attributeChangedCallback(t,e,i)}static get properties(){return{dataFields:{type:Object,attribute:"data-fields"},indent:{type:Number,reflect:!0},items:{type:Array},mouseWheelSpeed:{attribute:"mousewheel-speed",converter:{fromAttribute:t=>{switch((t=t.replace(/"|'/,"").replace(/"|'/,"")).toLowerCase()){case"veryslow":return IntegralUISpeedMode.VerySlow;case"slow":return IntegralUISpeedMode.Slow;case"fast":return IntegralUISpeedMode.Fast;case"veryfast":return IntegralUISpeedMode.VeryFast;default:return IntegralUISpeedMode.Normal}},toAttribute:t=>{switch(t){case IntegralUISpeedMode.VerySlow:return"VerySlow";case IntegralUISpeedMode.Slow:return"Slow";case IntegralUISpeedMode.Fast:return"Fast";case IntegralUISpeedMode.VeryFast:return"VeryFast";default:return"Normal"}}},reflect:!0},selectedItem:{type:Object,attribute:"selected-item"},title:{type:String,reflect:!0}}}set dataFields(t){const e=this._cDtFds;this._uDtFields(t);this.requestUpdate("dataFields",e)}get indent(){return this._cInd}set indent(t){if(this._cInd!==t){const e=this._cInd;this._cInd=t;this.requestUpdate("indent",e)}}get items(){return this._cIts}set items(t){const e=this._cIts;this._cIts=t;this._uDt();this.requestUpdate("items",e)}get mouseWheelSpeed(){return this._cMuWhSp}set mouseWheelSpeed(t){if(this._cMuWhSp!==t){const e=this._cMuWhSp;this._cMuWhSp=t;this.requestUpdate("mouseWheelSpeed",e)}}get selectedItem(){return this._cSel}set selectedItem(t){let e={cancel:!1,header:this._hdIt,item:t};this._inkEv("beforeSelect",e);if(!0!==e.cancel&&!this.isGroupItem(t)&&this._cSel!==t){const e=this._cSel;this._cSel=t;if(!t){this._hdIt=null;this._hdTxt=this.title}else if(t[this._cDtFds.items]&&t[this._cDtFds.items].length>0){this._hdIt=t;this._hdTxt=t.text}this.requestUpdate("selectedItem",e);this._inkEv("afterSelect",{header:this._hdIt,item:t});this._inkEv("selectionChanged");this.update()}}get title(){return this._cTtl}set title(t){if(this._cTtl!==t){const e=this._cTtl;this._cTtl=t;if(!this._hdIt)this._hdTxt=this._cTtl;this.requestUpdate("title",e)}}_uLt(t,e){let i=this;t.length=0;if(e)e.forEach(function(e){i._adChIts(t,e,0,null)})}_adChIts(t,e,i,s,l){let h=this,c=!0;if(!e[h._cDtFds.items])return c=h._adItCLt(t,e,i,s,l);if(h._adItCLt(t,e,i,s,l)){c=!0;if("group"===e[h._cDtFds.type]&&h.isItemExpanded(e)){let s=e[h._cDtFds.items];if(s)s.forEach(function(s){h._adChIts(t,s,i+h._cInd,e[h._cDtFds.id],e)})}}return c}_adItCLt(t,e,i,s,l){if(!this.isGroupItem(e))e[this._cDtFds.type]="item";if(!e[this._cDtFds.id])e[this._cDtFds.id]=this._cmnSrv.getUniqueId();if(s)e[this._cDtFds.pid]=s;let h=this._isItAlw(e);if(h)t.push({data:e,indent:i});return h}_uDt(){this._cDtaService.init([{data:this.items}])}_uDtFields(t){if(t)this._cDtFds={enabled:t.enabled?t.enabled:"enabled",expanded:t.expanded?t.expanded:"expanded",hasChildren:t.hasChildren?t.hasChildren:"hasChildren",icon:t.icon?t.icon:"icon",id:t.id?t.id:"id",items:t.items?t.items:"items",pid:t.pid?t.pid:"pid",selected:t.selected?t.selected:"selected",style:t.style?t.style:"style",text:t.text?t.text:"text",tooltip:t.tooltip?t.tooltip:"tooltip",type:t.type?t.type:"type",value:t.value?t.value:"value",visible:t.visible?t.visible:"visible"};else this._cDtFds={enabled:"enabled",expanded:"expanded",hasChildren:"hasChildren",icon:"icon",id:"id",items:"items",pid:"pid",selected:"selected",style:"style",text:"text",tooltip:"tooltip",type:"type",value:"value",visible:"visible"}}_rstSclATm(){if(this._scAppTm)clearTimeout(this._scAppTm);this._scAppTm=null}_uSclApp(t){let e=this;e._rstSclATm();this._scAppTm=setTimeout(function(){let i=e._cmnSrv.getShiftPos(),s=e._cmnSrv.getMousePos(t.detail.event);s.x-=i.x;s.y-=i.y;let l=e._cmnSrv.getPageRect(e.elemRef);if(s.x<=l.right&&s.x>=l.right-75)e._isScrollAvailable=!0;else e._isScrollAvailable=!1},100)}_ctrMuMv(t){if(this._enbl&&this._isVerScrollVisible())this._uSclApp(t);else this._isScrollAvailable=!1}_ctrMuLv(t){this._rstSclATm();this._isScrollAvailable=this._enbl&&this._scAct?!0:!1}_iMuEnt(t,e){if(this._enbl)this._hIt=e}_iMuLv(t,e){this._hIt=null}_iMuDn(t,e){let i=this;if(i._enbl&&1===t.detail.buttons&&e)if(i.isGroupItem(e)){let t=!1!==e[i._cDtFds.expanded]?!0:!1;e[i._cDtFds.expanded]=!t;i.updateLayout()}else if(e[i._cDtFds.items]&&e[i._cDtFds.items].length>0){i._selLt.push(i._hdIt);i._uLt(i._nxtLt,e[i._cDtFds.items]);i._cSclPs.y=0;let t=12,s=0,l=5/i._clRc.width,h=.5,c=1/i._clRc.width,_=0;if(i.allowAnimation){let a=setInterval(function(){if(s<i._clRc.width){s+=t;h-=l;_+=c;i._blkPs.left=-s;i._blkOp=h;i._rtBlkPs.left=i._clRc.width-s;i._rtBlkOp=_;i.update()}else{i.selectedItem=e;i._cLt.length=0;i.update();i._uLt(i._cLt,e[i._cDtFds.items]);i._blkPs.left=0;i._blkOp=1;i._rtBlkPs.left=i._clRc.width;i._rtBlkOp=0;i._uSclSz();i.update();clearInterval(a)}},10)}else{i.selectedItem=e;i._cLt.length=0;i.update();i._uLt(i._cLt,e[i._cDtFds.items]);i._blkPs.left=0;i._blkOp=1;i._rtBlkPs.left=i._clRc.width;i._rtBlkOp=0;i._uSclSz();i.update()}}else i.selectedItem=e}_hdMuDn(t){let e=this;if(e._enbl&&1===t.buttons&&e._selLt.length>0){let i=e._selLt.length-1,s=e._selLt[i]&&e._selLt[i][e._cDtFds.items]?e._selLt[i][e._cDtFds.items]:e.items;e._uLt(e._prvLt,s);e._cSclPs.y=0;let l=12,h=0,c=5/e._clRc.width,_=.5,a=1/e._clRc.width,r=0;if(e.allowAnimation){let d=setInterval(function(){if(h<e._clRc.width){h+=l;_-=c;r+=a;e._blkPs.left=h;e._blkOp=_;e._lfBlkPs.left=h-e._clRc.width;e._lfBlkOp=r;e.update()}else{e.selectedItem=e._selLt[i];e._cLt.length=0;e.update();e._uLt(e._cLt,s);e._selLt.splice(i,1);e._blkPs.left=0;e._blkOp=1;e._lfBlkPs.left=-e._clRc.width;e._lfBlkOp=0;e._uSclSz();e.update();clearInterval(d)}},10);e._isClk=!0;e._clkPs=e._cmnSrv.getClientPos(t,e._headerElem);let n=setTimeout(function(){e._isClk=!1;clearTimeout(n)},500)}else{e.selectedItem=e._selLt[i];e._cLt.length=0;e.update();e._uLt(e._cLt,s);e._selLt.splice(i,1);e._blkPs.left=0;e._blkOp=1;e._lfBlkPs.left=-e._clRc.width;e._lfBlkOp=0;e._uSclSz();e.update()}}}_gItElLt(){this._itemElems=this._blockElem?this._blockElem.querySelectorAll("iui-treelistitem"):null;return this._itemElems?this._itemElems:null}getItemParent(t){return this._cDtaService.getParent(t)}_gtItSt(t){if(t===this.selectedItem)return IntegralUIObjectState.Selected;else if(t===this._hIt)return IntegralUIObjectState.Hovered;return IntegralUIObjectState.Normal}isGroupItem(t){return t&&"group"===t[this._cDtFds.type]?!0:!1}_isItAlw(t){return t&&!1!==t[this._cDtFds.visible]?!0:!1}isItemExpanded(t){return t?t[this._cDtFds.expanded]||void 0===t[this._cDtFds.expanded]?!0:!1:!0}_isChIts(t){return t&&t[this._cDtFds.items]&&t[this._cDtFds.items].length>0?!0:!1}_rstLyTm(){if(this._uTmr)clearTimeout(this._uTmr);this._uTmr=null}_uBlkSz(){this._blkPs.top=this._lfBlkPs.top=this._rtBlkPs.top=this._headerElem.offsetHeight;this._blkSz={width:this._scBrSz.width,height:this._cBlkHt};this._lfBlkPs.left=-this._blkSz.width;this._rtBlkPs.left=this._blkSz.width;this._mxBlkHt=Math.max(this._blkSz.height,this._clRc.height-this._headerElem.offsetHeight)}async updateLayout(){this._uRf();await this._uCnt();await this._uSclSz();await this._uSclSz();this.update()}_uCnt(){let t=this;return new Promise(e=>{t._rstLyTm();t._uTmr=setTimeout(function(){t._clRc={width:t._eRf.clientWidth,height:t._eRf.clientHeight};t._uSelLt();t._uLt(t._cLt,t._hdIt?t._hdIt[t._cDtFds.items]:t.items);t.update();t._clRc={width:t._eRf.clientWidth,height:t._eRf.clientHeight};clearTimeout(t._uTmr);e()},1)})}_uSclSz(){let t=this;return new Promise(e=>{let i=setTimeout(function(){t._avgItHt=0;t._cBlkHt=0;let s=t._gItElLt();if(s&&s.length>0){for(let e=0;e<s.length;e++)t._cBlkHt+=s[e].getSize().height;t._avgItHt=Math.floor(t._cBlkHt/s.length)}t._anItSz={width:t._headerElem.offsetWidth,height:t._headerElem.offsetHeight};t._scSz={width:0,height:t._cBlkHt+t._headerElem.offsetHeight-t._clRc.height+2};t._scSz.width=t._scSz.width>2?t._scSz.width:0;t._scSz.height=t._scSz.height>2?t._scSz.height:0;t._mxSclPs={x:t._scSz.width,y:t._scSz.height};if(t._cSclPs.y>t._mxSclPs.y)t._chgVScPs(t._mxSclPs.y);t._scBrSz={width:t.isVerScrollVisible()?t._clRc.width-16:t._clRc.width,height:t.isHorScrollVisible()?t._clRc.height-16:t._clRc.height-4};t._scLgChg={x:t._scBrSz.width,y:t._scBrSz.height};t._uBlkSz();let l=t._cmnSrv.getPadding(t.headerElem),h=t._cmnSrv.getBorderWidth(t.headerElem);t._headerWidth=t._scBrSz.width-(l.left+l.right)-(h.left+h.right);t.update();clearTimeout(i);e()},1)})}_uSelLt(){this._selLt.length=0;if(this._hdIt){this._selLt.push(null);let t=this.getItemParent(this._hdIt);for(;t;){this._selLt.push(t);t=this.getItemParent(t)}}}updateView(){this._blkPs.top=this._headerElem.offsetHeight-this._cSclPs.y;this.update()}scrollPos(t){if(t){this._cSclPs={x:Math.max(0,Math.min(t.x,this._mxSclPs.x)),y:Math.max(0,Math.min(t.y,this._mxSclPs.y))};this._inkEv("scrollPosChanged",{value:this._cSclPs})}return{x:Math.floor(this._cSclPs.x),y:Math.floor(this._cSclPs.y)}}_chgVScPs(t){this._cSclPs.y=Math.max(0,Math.min(t,this._mxSclPs.y));if(this._cSclPs.y!==this._prvSclPs.y){this.updateView();this._inkEv("scrollPosChanged",{value:this.scrollPos()});this._prvSclPs.y=this._cSclPs.y}}_prcMuWh(t,e){if(this._enbl){this._hIt=null;let e=Math.max(-1,Math.min(1,t.wheelDelta||-t.detail)),i=5;switch(this.mouseWheelSpeed){case IntegralUISpeedMode.VerySlow:i=15;break;case IntegralUISpeedMode.Slow:i=9;break;case IntegralUISpeedMode.Fast:i=3;break;case IntegralUISpeedMode.VeryFast:i=1;break;default:i=5}t.preventDefault();if(this.isVerScrollVisible()){let t=Math.floor(this._clRc.height/i);if(this.mouseWheelSpeed===IntegralUISpeedMode.VerySlow&&this._avgItHt>0)t=this._avgItHt;let s=this._cSclPs.y+t*e*-1;this._chgVScPs(s)}t.stopPropagation()}}isHorScrollVisible(){return!1}isVerScrollVisible(){return this._enbl&&this._scAlw&&this._scSz.height>0?!0:!1}_oVScSt(t){this._hIt=null;this._scAct=!0}_oVScEd(t){this._scAct=!1;this._uSclApp(t)}_oVScChg(t){this._chgVScPs(t.detail.value)}_scMuEnt(t){}_gCtrSty(){let t={};if(this._ctrSz.width>0)t.width=this._ctrSz.width+"px";if(this._ctrSz.height>0)t.height=this._ctrSz.height+"px";return t}_uThSt(t){this._cThmSettings=css``;switch(t){case IntegralUITheme.Office:this._cThmSettings.cssText=this._cmnSrv.replaceAll(iuiTreeListOfficeStyle.cssText,"../icons",this._cRsPt);break;case IntegralUITheme.Midnight:this._cThmSettings.cssText=this._cmnSrv.replaceAll(iuiTreeListMidnightStyle.cssText,"../icons",this._cRsPt);break;default:this._cThmSettings.cssText=""}}firstUpdated(t){this._uRf();this.updateLayout()}_gItTpl(t){let e=this._cmnSrv.isString(t.icon)?t.icon.split(" "):[],i={};e.map(t=>i[t]=!0);return html`\n			<span class=${classMap(i)}></span>\n			<span class="iui-treelistitem-label">${t.text}</span>\n			${this._isChIts(t)?html`<span class="iui-treelistitem-expand-icon next"></span>`:html``}\n		`}render(){return html`\n            <style>\n				${this._cCtrStyStt}\n                ${this._cThmSettings}\n				${this._cCmSty}\n			</style>\n            <div data-ctrl="treelist" class=${classMap(this._gCtrCs())} style=${styleMap(this._gCtrSty())} @DOMMouseScroll="${t=>this._prcMuWh(t)}" @mousewheel="${t=>this._prcMuWh(t)}">\n                <div id="header" class="iui-treelist-header" style=${styleMap({width:this._headerWidth+"px"})} @mousedown="${t=>this._hdMuDn(t)}">\n                    ${this._hdIt?html`<span class="iui-treelist-header-back-icon back"></span>`:html``}\n                    <span class="iui-treelist-header-title">${this._hdTxt}</span>\n                </div>\n                <div class="iui-treelist-block" style=${styleMap({width:this._blkSz.width+"px",height:this._mxBlkHt+"px"})}">\n                    <ul id="leftBlock" class="iui-treelist-block" style=${styleMap({position:"absolute",top:this._lfBlkPs.top+"px",left:this._lfBlkPs.left+"px",width:this._blkSz.width+"px",height:this._mxBlkHt+"px",opacity:this._lfBlkOp})}>\n                        ${this._prvLt.map(t=>html`\n                            <iui-treelistitem .allowAnimation="${this.allowAnimation}" .enabled="${t.data.enabled}" .text="${t.data.text}" .templateRef="${this._gItTpl(t.data)}" .data="${t.data}" .customStyle="${this.customStyle}" .resourcePath="${this.resourcePath}" .theme="${this.theme}" .type="${t.data.type}"></iui-treelistitem> \n                        `)}\n                    </ul>\n                    <ul id="contentBlock" class="iui-treelist-block" style=${styleMap({position:"absolute",top:this._blkPs.top+"px",left:this._blkPs.left+"px",width:this._blkSz.width+"px",height:this._blkSz.height+"px",opacity:this._blkOp})}>\n                        ${this._cLt.map(t=>html`\n                            <iui-treelistitem .allowAnimation="${this.allowAnimation}" .enabled="${t.data.enabled}" .text="${t.data.text}" .templateRef="${this._gItTpl(t.data)}" .data="${t.data}" .indent="${t.indent}" .customStyle="${this.customStyle}" .resourcePath="${this.resourcePath}" .state="${this._gtItSt(t.data)}" .theme="${this.theme}" .type="${t.data.type}" @mouseDown="${e=>this._iMuDn(e,t.data)}" @mouseEnter="${e=>this._iMuEnt(e,t.data)}" @mouseLeave="${e=>this._iMuLv(e,t.data)}"></iui-treelistitem> \n                        `)}\n                    </ul>\n                    <ul id="rightBlock" class="iui-treelist-block" style=${styleMap({position:"absolute",top:this._rtBlkPs.top+"px",left:this._rtBlkPs.left+"px",width:this._blkSz.width+"px",height:this._mxBlkHt+"px",opacity:this._rtBlkOp})}>\n                        ${this._nxtLt.map(t=>html`\n                            <iui-treelistitem .allowAnimation="${this.allowAnimation}" .enabled="${t.data.enabled}" .text="${t.data.text}" .templateRef="${this._gItTpl(t.data)}" .data="${t.data}" .customStyle="${this.customStyle}" .resourcePath="${this.resourcePath}" .theme="${this.theme}" .type="${t.data.type}"></iui-treelistitem> \n                        `)}\n                    </ul>\n                </div>\n                ${this.isVerScrollVisible()?html`<iui-scrollbar id="ver-scroll" .enabled="${this.enabled}" .value="${this._cSclPs.y}" .max="${this._mxSclPs.y}" .largeChange="${this._scLgChg.y}" .height="${this._scBrSz.height}" .theme="${this._cThm}" @mouseenter="${t=>this._scMuEnt(t)}" @valueChanged="${t=>this._oVScChg(t)}" @scrollStart="${t=>this._oVScSt(t)}" @scrollEnd="${t=>this._oVScEd(t)}"></iui-scrollbar>`:html``}\n            </div>\n        `}_uCtrStyStt(t){this._cCtrStyStt=css``;this._cCtrStyStt.cssText=this._cmnSrv.replaceAll(iuiTreeListDefaultStyle.cssText,"../icons",t)}_uRf(){this._blockElem=this.shadowRoot.querySelector("#contentBlock");this._eRf=this.shadowRoot.querySelector("div[data-ctrl=treelist]");this._headerElem=this.shadowRoot.querySelector("#header");this._leftBlockElem=this.shadowRoot.querySelector("#leftBlock");this._rightBlockElem=this.shadowRoot.querySelector("#rightBlock");if(this._blockElem)this._itemElems=this._blockElem.querySelectorAll("iui-treelistitem")}}window.customElements.define("iui-treelist",IntegralUITreeList);export default IntegralUITreeList;